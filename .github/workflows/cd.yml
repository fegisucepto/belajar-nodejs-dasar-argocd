name: Continuous Deployment

on:
  push:
    tags:
      - 'v*'
    branches:
      - 'release/*'
      - 'main'

permissions:
  contents: read
  id-token: write

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    outputs:
      image_tag: ${{ steps.get_tag.outputs.tag_name }}
    steps:
      - uses: actions/checkout@v4

      - name: Get tag
        id: get_tag
        run: |
          if [[ "${GITHUB_REF}" == refs/tags/* ]]; then
            echo "tag_name=${GITHUB_REF##*/}" >> $GITHUB_OUTPUT
          else
            BRANCH_NAME="${GITHUB_REF#refs/heads/}"
            SAFE_BRANCH=$(echo "$BRANCH_NAME" | tr / -)
            echo "tag_name=latest-${SAFE_BRANCH}" >> $GITHUB_OUTPUT
          fi

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          tags: |
            ${{ secrets.DOCKERHUB_USERNAME }}/belajar-nodejs-dasar:${{ steps.get_tag.outputs.tag_name }}
            ${{ secrets.DOCKERHUB_USERNAME }}/belajar-nodejs-dasar:latest
          platforms: linux/amd64
          cache-from: type=gha
          cache-to: type=gha,mode=max

  deploy:
    needs: build-and-push
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install kubectl
        run: |
          curl -LO "https://dl.k8s.io/release/$(curl -L -s https://dl.k8s.io/release/stable.txt)/bin/linux/amd64/kubectl"
          chmod +x kubectl
          sudo mv kubectl /usr/local/bin/

      - name: Configure kubeconfig
        run: |
          mkdir -p ~/.kube
          echo "${{ secrets.KUBE_CONFIG }}" > ~/.kube/config
          chmod 600 ~/.kube/config

      - name: Deploy to Kubernetes
        env:
          DOCKERHUB_USERNAME: ${{ secrets.DOCKERHUB_USERNAME }}
          TAG: ${{ needs.build-and-push.outputs.image_tag || 'latest' }}
        run: |
          set -e
          
          # Create namespace if not exists
          kubectl create namespace belajar-nodejs --dry-run=client -o yaml | kubectl apply -f -
          
          # Deploy application
          kubectl apply -f k8s/
          
          # Wait for deployment to complete
          kubectl rollout status deployment/belajar-nodejs-dasar -n belajar-nodejs --timeout=180s

  notify:
    needs: [build-and-push, deploy]
    if: always()
    runs-on: ubuntu-latest
    steps:
      - name: Install kubectl
        run: |
          curl -LO "https://dl.k8s.io/release/$(curl -L -s https://dl.k8s.io/release/stable.txt)/bin/linux/amd64/kubectl"
          chmod +x kubectl
          sudo mv kubectl /usr/local/bin/

      - name: Configure kubeconfig
        if: always()
        run: |
          mkdir -p ~/.kube
          echo "${{ secrets.KUBE_CONFIG }}" > ~/.kube/config
          chmod 600 ~/.kube/config
          # Set KUBECONFIG environment variable
          echo "KUBECONFIG=~/.kube/config" >> $GITHUB_ENV

      - name: Send Slack Notification
        uses: rtCamp/action-slack-notify@v2
        env:
          SLACK_WEBHOOK: ${{ secrets.SLACK_WEBHOOK }}
          STATUS: ${{ job.status }}
          MESSAGE: |
            ${{ job.status == 'success' && '✅' || '❌' }} Deployment ${{ github.ref_name }}
            Status: ${{ job.status }}
            Workflow: ${{ github.workflow }}
            Commit: ${{ github.sha }}
            URL: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
            Cluster: $(kubectl config current-context 2>/dev/null || echo "N/A")
            Nodes: $(kubectl get nodes --no-headers 2>/dev/null | wc -l || echo "0")