name: Continuous Deployment

on:
  push:
    tags:
      - 'v*'
    branches:
      - 'release/*'
      - 'main'

permissions:
  contents: read
  id-token: write

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    outputs:
      image_tag: ${{ steps.get_tag.outputs.tag_name }}
    steps:
      - uses: actions/checkout@v4

      - name: Get tag
        id: get_tag
        run: |
          if [[ "${GITHUB_REF}" == refs/tags/* ]]; then
            echo "tag_name=${GITHUB_REF##*/}" >> $GITHUB_OUTPUT
          else
            BRANCH_NAME="${GITHUB_REF#refs/heads/}"
            SAFE_BRANCH=$(echo "$BRANCH_NAME" | tr / -)
            echo "tag_name=latest-${SAFE_BRANCH}" >> $GITHUB_OUTPUT
          fi

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          tags: |
            ${{ secrets.DOCKERHUB_USERNAME }}/belajar-nodejs-dasar-argocd:${{ steps.get_tag.outputs.tag_name }}
            ${{ secrets.DOCKERHUB_USERNAME }}/belajar-nodejs-dasar-argocd:latest
          platforms: linux/amd64
          cache-from: type=gha
          cache-to: type=gha,mode=max

  deploy:
    needs: build-and-push
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Install kubectl
        run: |
          curl -LO "https://dl.k8s.io/release/$(curl -L -s https://dl.k8s.io/release/stable.txt)/bin/linux/amd64/kubectl"
          chmod +x kubectl
          sudo mv kubectl /usr/local/bin/
      
      - name: Setup Minikube for local testing
        run: |
          # Install Minikube
          curl -LO https://storage.googleapis.com/minikube/releases/latest/minikube-linux-amd64
          chmod +x minikube-linux-amd64
          sudo mv minikube-linux-amd64 /usr/local/bin/minikube
          
          # Start Minikube
          minikube start --driver=docker
          
          # Verify cluster
          kubectl cluster-info
          kubectl get nodes
      
      - name: Authenticate to Google Cloud
        env:
          GCP_SA_KEY: ${{ secrets.GCP_SA_KEY }}
        run: |
          source $HOME/google-cloud-sdk/path.bash.inc
          echo "$GCP_SA_KEY" > gcp-key.json
          gcloud auth activate-service-account --key-file=gcp-key.json
          gcloud config set project polar-arbor-469013-i6
          gcloud auth configure-docker --quiet
          
          # Test authentication
          echo "Testing GCP authentication..."
          gcloud auth list
          gcloud container clusters list --project=polar-arbor-469013-i6
          gke-gcloud-auth-plugin version
      
      - name: Configure kubectl for cluster
        env:
          KUBE_CONFIG: ${{ secrets.KUBE_CONFIG }}
        run: |
          mkdir -p ~/.kube
          if [ -z "$KUBE_CONFIG" ]; then
            echo "KUBE_CONFIG secret is not set"
            exit 1
          fi
          echo "$KUBE_CONFIG" | base64 -d > ~/.kube/config
          kubectl cluster-info
      
      - name: Deploy Argo CD Application
        run: |
          # Deploy Argo CD Application manifest
          kubectl apply -f k8s/argocd-app.yaml
          
          # Wait untuk Argo CD sync aplikasi
          echo "Waiting for Argo CD to sync application..."
          sleep 30
          
          # Check status aplikasi
          kubectl get applications -n argocd
          kubectl get pods -n belajar-nodejs
      
      - name: Update image tag in deployment
        env:
          DOCKERHUB_USERNAME: ${{ secrets.DOCKERHUB_USERNAME }}
          TAG: ${{ needs.build-and-push.outputs.image_tag || 'latest' }}
        run: |
          # Update image tag di deployment.yaml
          sed -i "s|image: ${DOCKERHUB_USERNAME}/belajar-nodejs-dasar-argocd:latest|image: ${DOCKERHUB_USERNAME}/belajar-nodejs-dasar-argocd:${TAG}|g" k8s/deployment.yaml
          
          # Commit dan push perubahan ke Git untuk trigger Argo CD
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"
          git add k8s/deployment.yaml
          git commit -m >
            "feat: Update image tag to ${TAG} for Argo CD deployment

            ü§ñ Automated update from GitHub Actions
            üì¶ Image: ${DOCKERHUB_USERNAME}/belajar-nodejs-dasar-argocd:${TAG}
            üöÄ Trigger: Argo CD will sync automatically

            [skip ci]"
          git push
          
          # Jika ini adalah tag release, buat tag baru
          if [[ "${TAG}" == v* ]]; then
            echo "Creating release tag: ${TAG}"
            git tag -a "${TAG}" -m |
              Release ${TAG}

              üöÄ Automated Release
              üì¶ Image: ${DOCKERHUB_USERNAME}/belajar-nodejs-dasar-argocd:${TAG}
              üîÑ Deployed via Argo CD
              ‚è∞ Date: $(date -u)
              üìù Commit: ${GITHUB_SHA}
            git push origin "${TAG}"
            echo "‚úÖ Tag ${TAG} created and pushed"
          else
            echo "üîÑ Updated image tag to ${TAG} (not a release tag)"
          fi
          
          # Wait untuk Argo CD sync
          echo "Waiting for Argo CD to sync new image..."
          sleep 60
          
          # Check final status
          kubectl get pods -n belajar-nodejs -o wide

  notify:
    needs: [build-and-push, deploy]
    if: always()
    runs-on: ubuntu-latest
    steps:
      - name: Get deployment status
        id: deployment-status
        run: |
          if [[ "${{ needs.deploy.result }}" == "success" ]]; then
            echo "cluster_context=minikube" >> $GITHUB_OUTPUT
            echo "deployment_status=success" >> $GITHUB_OUTPUT
          else
            echo "cluster_context=error" >> $GITHUB_OUTPUT
            echo "deployment_status=failed" >> $GITHUB_OUTPUT
          fi

      - name: Send Slack Notification
        uses: rtCamp/action-slack-notify@v2
        env:
          SLACK_WEBHOOK: ${{ secrets.SLACK_WEBHOOK_URL }}
          SLACK_TITLE: "Deployment ${{ job.status == 'success' && '‚úÖ' || '‚ùå' }} - ${{ github.workflow }}"
          SLACK_MESSAGE: |
            *Status*: ${{ job.status == 'success' && 'Berhasil' || 'Gagal' }}
            *Branch/Tag*: ${{ github.ref_name }}
            *Workflow*: ${{ github.workflow }}
            *Commit*: `${{ github.sha }}` 
            *Cluster*: ${{ steps.deployment-status.outputs.cluster_context }}
            *View Logs*: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
          SLACK_COLOR: ${{ job.status == 'success' && '#36a64f' || '#ff0000' }}
          MSG_MINIMAL: "true"