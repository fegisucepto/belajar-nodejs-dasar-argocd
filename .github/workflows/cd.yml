name: Continuous Deployment

on:
  push:
    tags:
      - 'v*'
    branches:
      - 'release/*'
      - 'main'

permissions:
  contents: read
  id-token: write

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    outputs:
      image_tag: ${{ steps.get_tag.outputs.tag_name }}
    steps:
      - uses: actions/checkout@v4

      - name: Get tag
        id: get_tag
        run: |
          if [[ "${GITHUB_REF}" == refs/tags/* ]]; then
            echo "tag_name=${GITHUB_REF##*/}" >> $GITHUB_OUTPUT
          else
            BRANCH_NAME="${GITHUB_REF#refs/heads/}"
            SAFE_BRANCH=$(echo "$BRANCH_NAME" | tr / -)
            echo "tag_name=latest-${SAFE_BRANCH}" >> $GITHUB_OUTPUT
          fi

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          tags: |
            ${{ secrets.DOCKERHUB_USERNAME }}/belajar-nodejs-dasar:${{ steps.get_tag.outputs.tag_name }}
            ${{ secrets.DOCKERHUB_USERNAME }}/belajar-nodejs-dasar:latest
          platforms: linux/amd64
          cache-from: type=gha
          cache-to: type=gha,mode=max

  deploy:
    needs: build-and-push
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install kubectl and minikube
        run: |
          # Install kubectl
          curl -LO "https://dl.k8s.io/release/$(curl -L -s https://dl.k8s.io/release/stable.txt)/bin/linux/amd64/kubectl"
          chmod +x kubectl
          sudo mv kubectl /usr/local/bin/

          # Install minikube
          curl -LO https://github.com/kubernetes/minikube/releases/latest/download/minikube-linux-amd64
          sudo install minikube-linux-amd64 /usr/local/bin/minikube

      - name: Start Minikube
        run: |
          # Stop and clean Minikube
          minikube delete || true
          
          # Start Minikube with simple configuration
          minikube start \
            --driver=docker \
            --cpus=2 \
            --memory=4g \
            --kubernetes-version=stable \
            --wait=true
          
          # Wait for Minikube to be ready
          minikube status

      - name: Deploy to Kubernetes
        env:
          DOCKERHUB_USERNAME: ${{ secrets.DOCKERHUB_USERNAME }}
          TAG: ${{ needs.build-and-push.outputs.image_tag || 'latest' }}
        run: |
          set -e
          
          # Create namespace if not exists
          minikube kubectl -- create namespace belajar-nodejs --dry-run=client -o yaml | minikube kubectl -- apply -f -
          
          # Deploy application
          minikube kubectl -- apply -f k8s/ -n belajar-nodejs
          
          # Wait for MongoDB to be ready
          echo "Waiting for MongoDB to be ready..."
          minikube kubectl -- rollout status deployment/mongo -n belajar-nodejs --timeout=300s
          
          # Wait for app pod to be created and running
          echo "Waiting for app pod to be ready..."
          minikube kubectl -- wait --for=condition=ready pod -n belajar-nodejs -l app=belajar-nodejs-dasar --timeout=600s
          
          # Check pod status
          echo "Checking pod status..."
          minikube kubectl -- get pods -n belajar-nodejs -o wide
          
          # Wait for app deployment to complete
          echo "Waiting for application deployment to complete..."
          minikube kubectl -- rollout status deployment/belajar-nodejs-dasar -n belajar-nodejs --timeout=900s
          
          # Check app logs after deployment is ready
          echo "Checking application logs..."
          minikube kubectl -- logs -n belajar-nodejs deployment/belajar-nodejs-dasar --tail=50 || echo "No logs available yet"
          
          # Verify MongoDB connection after app is ready
          echo "Verifying MongoDB connection..."
          minikube kubectl -- exec -n belajar-nodejs deployment/belajar-nodejs-dasar -- env | grep MONGO_URI || echo "MongoDB URI verified"

  notify:
    needs: [build-and-push, deploy]
    if: always()
    runs-on: ubuntu-latest
    steps:
      - name: Get deployment status
        id: deployment-status
        run: |
          if [[ "${{ needs.deploy.result }}" == "success" ]]; then
            echo "cluster_context=minikube" >> $GITHUB_OUTPUT
            echo "deployment_status=success" >> $GITHUB_OUTPUT
          else
            echo "cluster_context=error" >> $GITHUB_OUTPUT
            echo "deployment_status=failed" >> $GITHUB_OUTPUT
          fi

      - name: Send Slack Notification
        uses: rtCamp/action-slack-notify@v2
        env:
          SLACK_WEBHOOK: ${{ secrets.SLACK_WEBHOOK_URL }}
          SLACK_TITLE: "Deployment ${{ job.status == 'success' && '✅' || '❌' }} - ${{ github.workflow }}"
          SLACK_MESSAGE: |
            *Status*: ${{ job.status == 'success' && 'Berhasil' || 'Gagal' }}
            *Branch/Tag*: ${{ github.ref_name }}
            *Workflow*: ${{ github.workflow }}
            *Commit*: `${{ github.sha }}` 
            *Cluster*: ${{ steps.deployment-status.outputs.cluster_context }}
            *View Logs*: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
          SLACK_COLOR: ${{ job.status == 'success' && '#36a64f' || '#ff0000' }}
          MSG_MINIMAL: "true"