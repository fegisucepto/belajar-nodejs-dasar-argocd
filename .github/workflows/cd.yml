name: Continuous Deployment

on:
  push:
    tags:
      - 'v*'
    branches:
      - 'release/*'

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    outputs:
      image_tag: ${{ steps.get_tag.outputs.tag_name }}
    steps:
      - uses: actions/checkout@v4
      
      - name: Get tag
        id: get_tag
        run: |
          if [[ $GITHUB_REF == refs/tags/* ]]; then
            echo "tag_name=${GITHUB_REF##*/}" >> $GITHUB_OUTPUT
          else
            echo "tag_name=latest" >> $GITHUB_OUTPUT
          fi
          
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      
      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}
      
      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          tags: |
            ${{ secrets.DOCKERHUB_USERNAME }}/belajar-nodejs-dasar:${{ steps.get_tag.outputs.tag_name }}
            ${{ secrets.DOCKERHUB_USERNAME }}/belajar-nodejs-dasar:latest
          platforms: linux/amd64
          cache-from: type=gha
          cache-to: type=gha,mode=max

  deploy:
    needs: build-and-push
    runs-on: ubuntu-latest
    # Add environment variables here
    env:
      KUBECONFIG: ~/.kube/config
      MINIKUBE_HOME: ${{ github.workspace }}/.minikube
    environment:
      name: ${{ contains(github.ref, 'release/') && 'staging' || 'production' }}
      url: ${{ steps.deploy.outputs.url }}
    steps:
      - uses: actions/checkout@v4
      
      - name: Install kubectl and minikube
        run: |
          curl -LO "https://dl.k8s.io/release/$(curl -L -s https://dl.k8s.io/release/stable.txt)/bin/linux/amd64/kubectl"
          chmod +x kubectl
          sudo mv kubectl /usr/local/bin/
          curl -LO https://github.com/kubernetes/minikube/releases/latest/download/minikube-linux-amd64
          sudo install minikube-linux-amd64 /usr/local/bin/minikube
      
      - name: Start Minikube
        run: |
          minikube start --driver=docker --force
          minikube addons enable ingress
          minikube addons enable metrics-server
      
      - name: Configure kubeconfig
        run: |
          mkdir -p ~/.kube
          echo "${{ secrets.KUBE_CONFIG }}" > ~/.kube/config
          chmod 600 ~/.kube/config
          # Fix certificate issues
          minikube update-context
          kubectl config set-cluster minikube --insecure-skip-tls-verify=true
          # Verify connection
          kubectl cluster-info
          kubectl get nodes
      
      - name: Deploy to Kubernetes
        id: deploy
        run: |
          # Create namespace
          kubectl create namespace belajar-nodejs --dry-run=client -o yaml | kubectl apply -f -
          
          # Apply manifests
          kubectl apply -f k8s/ --insecure-skip-tls-verify=true
          
          # Debug pods
          kubectl get pods -n belajar-nodejs -w &
          kubectl describe deployment belajar-nodejs-dasar -n belajar-nodejs
          kubectl get events -n belajar-nodejs --sort-by='.lastTimestamp'
    
          # Wait for deployment with timeout
          timeout 180 kubectl rollout status deployment/belajar-nodejs-dasar -n belajar-nodejs --timeout=90s --insecure-skip-tls-verify=true || true
    
          # Get pod logs if deployment fails
          if [ $? -ne 0 ]; then
            echo "Deployment failed, showing pod logs:"
            kubectl logs -n belajar-nodejs -l app=belajar-nodejs-dasar --tail=50 || true
            exit 1
          fi
    
          echo "url=http://$(minikube ip):$(kubectl get svc belajar-nodejs-dasar -n belajar-nodejs -o jsonpath='{.spec.ports[0].nodePort}' --insecure-skip-tls-verify=true)" >> $GITHUB_OUTPUT

      - name: Debug Minikube
        run: |
          minikube status
          minikube logs
          kubectl version --client
          kubectl cluster-info
          
  notify:
    needs: [build-and-push, deploy]
    if: always()
    runs-on: ubuntu-latest
    steps:
      - uses: rtCamp/action-slack-notify@v2
        env:
          SLACK_WEBHOOK: ${{ secrets.SLACK_WEBHOOK_URL }}
          STATUS: ${{ job.status }}
          MESSAGE: |
            ${{ job.status == 'success' && '✅' || '❌' }} Deployment ${{ github.ref_name }}
            Environment: ${{ contains(github.ref, 'release/') && 'Staging' || 'Production' }}
            Commit: ${{ github.sha }}
            URL: ${{ needs.deploy.outputs.url || 'N/A' }}
            Lihat detail: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}